\documentclass[11pt, russian]{book}

\usepackage{lipsum} % DELME

\sloppy
%%% Константы %%%
\newcommand{\Author}{В.~И.~Великодный}
\newcommand{\AuthorI}{Великодный~В.~И.}
\newcommand{\Title}{Программирование}
\newcommand{\SubTitle}{Часть I}
\newcommand{\PubType}{Курс лекций}
\newcommand{\Year}{2016}

\newcommand{\UDC}{???} % УДК
\newcommand{\BBK}{???} % ББК
\newcommand{\AS}{В??}  % Авторский знак

%%% Математические окружения %%%
\usepackage{amsthm}

\newtheoremstyle{DefinitionStyle}  % name
                {10pt}             % Space above
                {10pt}             % Space below
                {}                 % Body font
                {\parindent}       % Indent amount
                {\scshape}         % Theorem head font
                {.}                % Punctuation after theorem head
                {.5em}             % Space after theorem head
                {}                 % Theorem head spec (can be left empty, meaning ‘normal’)

\theoremstyle{DefinitionStyle}
\newtheorem*{defn}{\protect\definitionname}
\providecommand{\definitionname}{Определение}

\theoremstyle{DefinitionStyle}
\newtheorem*{example}{\protect\examplename}
\providecommand{\examplename}{Пример}

%%% Математические шрифты %%%
\usepackage{amssymb}
\usepackage{mathspec}
\usepackage[charter]{mathdesign}

%%% Специальные символы %%%
\usepackage{gensymb}

%%% Шрифты документа %%%
\usepackage{fontspec}

\defaultfontfeatures{Scale=MatchLowercase,Mapping=tex-text}
\setmainfont[Path = ../fonts/,
	BoldFont = CharisSIL-B.ttf,
  	ItalicFont = CharisSIL-I.ttf,
  	BoldItalicFont = CharisSIL-BI.ttf]
  	{CharisSIL-R.ttf}
\setsansfont[Path = ../fonts/]{Ubuntu-R.ttf}
\setmonofont[Path = ../fonts/]{UbuntuMono-R.ttf}

%%% XeTeX fix
\newfontfamily{\cyrillicfont}{CharisSIL-R.ttf}[Path = ../fonts/,
	BoldFont = CharisSIL-B.ttf,
  	ItalicFont = CharisSIL-I.ttf,
  	BoldItalicFont = CharisSIL-BI.ttf]

%%% Семейства шрифтов %%%
\newfontfamily\footfont{Ubuntu-R.ttf}[Path = ../fonts/]
\newfontfamily\titlefont{Ubuntu-R.ttf}[Path = ../fonts/, FakeBold = 1.5]
\newfontfamily\authorfont{Ubuntu-R.ttf}[Path = ../fonts/]
\newfontfamily\lstfont{Ubuntu-R.ttf}[Path = ../fonts/]

%%% Графика %%%
\usepackage{graphicx}
\usepackage{tikz}
\usetikzlibrary{positioning,arrows}

%%% Тексты программ %%%
\usepackage{listings}
\lstset{
  basicstyle={\lstfont},
  breaklines=true,
  language={[Sharp]C},
  numbers=left,
  numberstyle={\scriptsize},
  showstringspaces=false,
  tabsize=4,
  escapeinside={\%*}{*)}            % if you want to add LaTeX within your code
}
\lstset{morekeywords={var}}

%%% Геометрия страницы %%%
\usepackage[
  twoside,
  driver=xetex,
  a5paper,
  includefoot,
  headsep=0mm,
  tmargin=1.5cm,
  bmargin=1.5cm,
  lmargin=1.5cm,
  rmargin=1.5cm
]{geometry}

%%% Колонтитулы %%%
\usepackage{fancyhdr}

%\renewcommand{\chaptermark}[1]{\markboth{#1}{}} % Отображать названия
                                                % в нижнем регистре
\fancypagestyle{fancystyle}{
  \fancyhf{}
  \fancyfoot[LE]{
    \footfont\textbf{\thepage}~|~\nouppercase{\leftmark{}}%
  }
  \fancyfoot[RO]{
    \footfont \nouppercase{\rightmark{}}~|~\textbf{\thepage}
  }
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0.4pt}
}

\fancypagestyle{plain}{
  \fancyhf{}
  \fancyfoot[C]{\footfont\textbf{\thepage}}
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\footrulewidth}{0.4pt}
}

%%% Настройки PDF %%%
\usepackage[
  unicode=true,
  bookmarks=true,
  bookmarksnumbered=false,
  bookmarksopen=false,
  breaklinks=false,
  pdfborder={0 0 0},
  backref=false,
  colorlinks=false
]{hyperref}
\hypersetup{
  pdftitle={\Title},
  pdfauthor={\Author}
}
\urlstyle{same}

%%% Локализация %%%
\usepackage{xunicode}
\usepackage{polyglossia}
\setdefaultlanguage[spelling=modern]{russian}
\setotherlanguage{english}

%%% Точки после номеров рисунков и таблиц %%%
\usepackage{ccaption}
\captiondelim{. }

%%% Прочее %%%
\usepackage{indentfirst}
%\usepackage[russian]{varioref}
\usepackage{mathtext}
\usepackage[normalem]{ulem} % ???
\usepackage{stmaryrd} % ???
\usepackage{calc}
\usepackage{fancyvrb}
\usepackage{rotating}
\usepackage{bytefield} % Рисование карт памяти
\usepackage{epigraph}  % Эпиграфы
\usepackage{lastpage}

%%% Индекс %%%
\usepackage{makeidx}
\makeindex

%%% Библиография
\bibliographystyle{ugost2008s}

%%% Нумерация разделов %%%
\setcounter{secnumdepth}{1}
\setcounter{tocdepth}{1}
\usepackage{titlesec}
\titleformat*{\subsection}
             {\normalfont\normalsize\bfseries\lstfont}
\titlespacing*{\subsection}
              {\parindent}
              {0.3em}
              {0.3em}
